# TrapperKeeper test utils #

Trapperkeeper provides some [utility code](./test/puppetlabs/trapperkeeper/testutils)
for use in tests. The code is available in a separate "test" jar that you may depend
on by using a classifier in your project dependencies.

```clojure
  (defproject yourproject "1.0.0"
    ...
    :profiles {:test {:dependencies [[puppetlabs/trapperkeeper "x.y.z" :classifier "test"]]}})
```

## Logging Test Utils ##

Some utilities to ensure that the correct logging messages are generated by your application code are located in
[logging.clj](../test/puppetlabs/trapperkeeper/testutils/logging.clj)

### with-test-logging ###

All logging messages generated by code executed using the `with-test-logging` macro are available for later inspection.
A simple example would be:

```clojure
(with-test-logging
  (log/info "hello log")
  (is (logged? #"^hello log$"))
  (is (logged? #"^hello log$" :info)))
```

In this code `(log/info "hello log")` generates the message `hello log` at the `INFO` level. The existence of this
message is then later tested by the `logged?` function.

### logged? ###

The `logged?` function always takes a regex as its first parameter, declared with Clojure's `#"pattern"` notation. If
this regex matches any line that has been logged within the body of a `with-test-logging` then `true` will be returned.

The optional second parameter is a keyword describing a log level to specifically search in. It currently can be one of
`:trace`, `:debug`, `:info`, `:warn`, `:error` or `:fatal`.

## Jetty test utils ##

_Trapperkeeper_'s test jar also contains a macro to assist in testing the functionality of a ring application which is
defined in [jetty.clj](../test/puppetlabs/trapperkeeper/testutils/jetty.clj).

### with-test-jetty ###

The `with-test-jetty` macro starts up a new Jetty server which is bound to a random unused port, and attaches a
provided Ring handler function. When the test is completed `with-test-jetty` also handles shutting down the Jetty
server.

The first parameter provided to the `with-test-jetty` macro is a ring handler function (see
[ring concepts](https://github.com/ring-clojure/ring/wiki/Concepts)) which will generally by a handler that exists in
your _trapperkeeper_ application somewhere. The second parameter is an identifier which will contain the port number
that the Jetty server was started on.

Generally, inside the body of the `with-test-jetty` macro a number of web requests are made and their responses are
examined for correctness. For example:

```clojure
(with-test-jetty app port
  (testing "a gzipped response when requests"
    ;; The client/get function asks for compression by default
    (let [resp (http-client/get (format "http://localhost:%d/" port))]
      (is (= (resp :body) body))
      (is (= (get-in resp [:headers "content-encoding"]) "gzip")
          (format "Expected gzipped response, got this response: %s" resp))))
                
```